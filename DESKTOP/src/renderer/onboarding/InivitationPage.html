<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invitation Page</title>
    <link rel="stylesheet" href="../onboarding/InvitationPage.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <main class="invitation-container">
        <section class="invitation-content">
            <div id="responseMessage" class="response-message"></div>
            
            <div id="invitationContent">
                <h1>YOU ARE INVITED</h1>
                <p class="invitation-title">THE WEDDING OF</p>
                <div class="line"></div>

                <h2 id="clientNames" class="client-name">Loading...</h2>
                <h4 id="eventDate" class="invitation-date">Loading...</h4>

                <p class="invitation-message">Kindly confirm your attendance to reserve your seat.</p>

                <section class="button-container">
                    <button class="btn going" onclick="respondToInvitation('Accepted')">Going</button>
                    <button class="btn decline" onclick="respondToInvitation('Declined')">Decline</button>
                </section>
            </div>
        </section>
    </main>

    <script>
        // Extract parameters from URL
        const pathSegments = window.location.pathname.split('/');
        const eventId = pathSegments[2];
        const guestId = pathSegments[3];
        const token = pathSegments[4];

        let guestData = null;

        // Load invitation data
        async function loadInvitation() {
            try {
                const response = await fetch(`/api/event-plans/invitation/${eventId}/${guestId}/${token}`);
                const data = await response.json();

                if (data.success) {
                    guestData = data.guest;
                    displayInvitationData(data.guest);
                } else {
                    showError('Invalid invitation link');
                }
            } catch (error) {
                console.error('Error loading invitation:', error);
                showError('Failed to load invitation');
            }
        }

        function displayInvitationData(guest) {
            document.getElementById('clientNames').textContent = 
                `${guest.event.client_name} & ${guest.event.partner_name}`;
            
            document.getElementById('eventDate').textContent = 
                new Date(guest.event.event_date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

            // If already responded, show status
            if (guest.status === 'Accepted' || guest.status === 'Declined') {
                showResponseMessage(`You have already ${guest.status.toLowerCase()} this invitation.`, 'success');
                document.querySelector('.button-container').style.display = 'none';
            }
        }

        async function respondToInvitation(status) {
            if (!guestData) return;

            try {
                // Show loading state
                document.getElementById('invitationContent').classList.add('loading');
                
                const response = await fetch(`/api/event-plans/invitation/${eventId}/${guestId}/${token}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                const data = await response.json();

                if (data.success) {
                    showResponseMessage(data.message, 'success');
                    document.querySelector('.button-container').style.display = 'none';
                    
                    // Notify parent window if embedded
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'INVITATION_RESPONSE',
                            guestId: guestId,
                            status: status
                        }, '*');
                    }
                } else {
                    showResponseMessage(data.error, 'error');
                }
            } catch (error) {
                console.error('Error responding to invitation:', error);
                showResponseMessage('Failed to send response', 'error');
            } finally {
                document.getElementById('invitationContent').classList.remove('loading');
            }
        }

        function showResponseMessage(message, type) {
            const messageEl = document.getElementById('responseMessage');
            messageEl.textContent = message;
            messageEl.className = `response-message response-${type}`;
            messageEl.style.display = 'block';
        }

        function showError(message) {
            document.getElementById('invitationContent').innerHTML = `
                <div class="response-message response-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${message}
                </div>
            `;
        }

        // Load invitation when page loads
        document.addEventListener('DOMContentLoaded', loadInvitation);
    </script>
</body>
</html>